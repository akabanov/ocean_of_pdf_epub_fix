<!DOCTYPE html>
<!--suppress HtmlUnknownTag -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-6264597851053551">

    <title>EPUB Liberator for Kobo</title>
    <meta name="description"
          content="Liberates line spacing, text alignment, and font size settings in EPUBs for Kobo.">

    <meta name="theme-color" content="#8A9A5B">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="EPUB Fixer">

    <link rel="icon" href="favicon.ico" type="image/png"/>
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <link rel="manifest" href="manifest.json">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary-sage: #8A9A5B;
            --primary-sage-dark: #6b7a42;
            --accent-orange: #E9967A;
            --accent-orange-pop: #FF7F50;
            --bg-cream: #F9F7F2;
            --text-dark: #333333;
            --text-light: #666666;
            --card-shadow: 0 10px 25px rgba(138, 154, 91, 0.15);
        }

        html,
        body {
            width: 100%;
            overflow-x: hidden;
            /* Prevent horizontal scroll */
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-cream);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            /* Prevent font scaling on mobile */
            text-size-adjust: 100%;
        }

        /* Header */
        header {
            background-color: white;
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 4px solid var(--primary-sage);
        }

        h1 {
            margin: 0;
            color: var(--primary-sage-dark);
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .quote {
            font-style: italic;
            color: var(--text-light);
            margin-top: 10px;
            font-family: serif;
            font-size: 1.1rem;
        }

        /* Main Content */
        main {
            flex: 1;
            max-width: 800px;
            width: 95%;
            margin: 2rem auto;
            background: white;
            border-radius: 12px;
            padding: 1rem 1rem 2rem;
            box-shadow: var(--card-shadow);
            box-sizing: border-box;
        }

        .intro {
            text-align: center;
            margin-top: 0;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* Promo Block */
        .promo-block {
            background: #faf9f5;
            border: 1px solid #ebe9e1;
            border-radius: 10px;
            padding: 12px;
            margin: 16px 0;
            transition: background-color 0.15s ease, border-color 0.15s ease;
        }

        .promo-block:hover {
            background: #f5f3ed;
            border-color: #e4e1d7;
        }

        .promo-title {
            margin: 0 0 8px 0;
            font-size: 1rem;
            color: var(--primary-sage-dark);
            font-weight: 600;
        }

        .promo-body {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .promo-message {
            margin: 0;
            color: var(--text-dark);
            line-height: 1.4;
        }

        .promo-message a {
            color: var(--accent-orange-pop);
            text-decoration: underline;
        }

        .promo-image {
            width: 300px;
            height: auto;
            max-width: 45vw;
        }

        .promo-disclaimer {
            margin-top: 8px;
            padding-top: 8px;
            /*border-top: 1px dashed #ddd8c9;*/
            font-size: 0.8rem;
            color: #555;
        }

        /* Responsive: stack image under the text on smaller screens */
        @media (max-width: 520px) {
            .promo-body {
                flex-direction: column;
                align-items: flex-start;
            }

            .promo-image {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Options Grid */
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin: .7rem auto 0;
        }

        .option-card {
            padding: 0.25rem;
            border-radius: 8px;
            transition: transform 0.2s;
            text-wrap: nowrap;
        }

        .option-card:hover {
            background-color: #fafbf8;
        }

        label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }

        input[type="checkbox"] {
            accent-color: var(--accent-orange-pop);
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            margin-top: 3px;
        }

        .opt-title {
            display: block;
            font-weight: bold;
            color: var(--primary-sage-dark);
            margin-top: auto;
            margin-bottom: auto;
        }

        /* File Drop Area */
        .drop-zone {
            border: 2px dashed var(--primary-sage);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            background-color: #fafbf8;
            position: relative;
        }

        .drop-zone:hover {
            background-color: #eff2ea;
            border-color: var(--accent-orange);
        }

        .drop-text {
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .drop-sub {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 10px;
        }

        #fileInput {
            display: none;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 2rem;
            display: none;
            /* Hidden by default */
        }

        .progress-bar-shell {
            width: 100%;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary-sage), var(--accent-orange));
            transition: width 0.1s linear;
        }

        .status-text {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            font-style: italic;
            color: var(--primary-sage-dark);
        }

        /* Links Section */
        .links-section {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            text-align: left;
        }

        .links-section h3 {
            font-size: 1.4rem;
            color: var(--text-dark);
            margin-bottom: .5rem;
        }

        .links-intro {
            color: var(--text-light);
            margin: 0 0 1.25rem 0;
            line-height: 1.6;
            font-size: .95rem;
        }

        .resource-cards {
            list-style: none;
            padding-left: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }

        .resource-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,.04);
            transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
            cursor: pointer; /* make whole card feel clickable */
        }

        .resource-card:hover {
            border-color: var(--primary-sage);
        }

        .site-head {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin: 0 0 6px 0;
        }

        .site-title {
            margin: 0;
            font-size: 1.05rem;
            color: var(--text-dark);
        }

        .site-link {
            color: var(--accent-orange-pop);
            text-decoration: none;
            font-size: .9rem;
            white-space: nowrap;
        }

        .site-link:hover,
        .site-link:focus {
            text-decoration: underline;
        }

        .site-tagline {
            display: inline-block;
            font-size: .85rem;
            color: var(--primary-sage-dark);
            background: rgba(88, 129, 87, .08);
            border: 1px solid rgba(88,129,87,.25);
            padding: 2px 8px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .site-desc {
            color: var(--text-light);
            margin: 8px 0 12px 0;
            font-size: .95rem;
            line-height: 1.5;
        }

        .card-link {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--primary-sage);
            color: #fff;
            text-decoration: none;
            font-size: .9rem;
            transition: background .2s ease;
        }

        .card-link:hover,
        .card-link:focus {
            background: var(--accent-orange-pop);
        }

        .disclaimer {
            font-size: 0.8rem;
            color: #777;
            margin-top: 2rem;
        }

        .disclaimer p {
            margin: .5rem auto;
        }

        /* Footer */
        footer {
            background-color: var(--text-dark);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: auto;
        }

        .footer-links a {
            color: var(--accent-orange);
            text-decoration: none;
            font-weight: bold;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        /* Cookie Banner */
        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--text-dark);
            color: var(--bg-cream);
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            /* Hidden by default, JS will show it */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            text-align: center;
            border-top: 4px solid var(--accent-orange);
            box-sizing: border-box;
        }

        @media (min-width: 600px) {
            .cookie-banner {
                flex-direction: row;
                justify-content: space-between;
                padding: 1rem 2rem;
                text-align: left;
            }
        }

        .cookie-text {
            margin-bottom: 1rem;
            font-size: 0.95rem;
            max-width: 800px;
        }

        @media (min-width: 600px) {
            .cookie-text {
                margin-bottom: 0;
                margin-right: 2rem;
            }
        }

        .cookie-buttons {
            display: flex;
            gap: 1rem;
        }

        .cookie-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.2s;
        }

        .cookie-btn:active {
            transform: scale(0.95);
        }

        .btn-accept {
            background-color: var(--primary-sage);
            color: white;
        }

        .btn-accept:hover {
            background-color: var(--primary-sage-dark);
        }

        .btn-decline {
            background-color: transparent;
            border: 1px solid var(--text-light);
            color: var(--text-light);
        }

        .btn-decline:hover {
            border-color: white;
            color: white;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MNCZGHFB0K"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    // Default consent to denied
    gtag('consent', 'default', {
        'ad_storage': 'denied',
        'analytics_storage': 'denied'
    });

    gtag('js', new Date());

    gtag('config', 'G-MNCZGHFB0K');
</script>

<body>

<header>
    <h1>EPUB Liberator</h1>
    <div class="quote">
        "A better formatted EPUB is better than not." — Some Wise Man
        <!--        <br/>-->
        <!--        Get more wisdom from FAQs and Hacks <a href="#faq">down below</a>.-->
    </div>
</header>

<main>
    <div class="intro">
        <p>
            <strong>Stop squinting at bad text.</strong>
            This tool unlocks line spacing, text alignment, and font size settings in your messed-up free download
            EPUB books and lets you read them with comfort on your Kobo screen.
        </p>
    </div>

    <div class="promo-block" id="promoAmazon" role="link" tabindex="0"
         aria-label="Amazon: Lightning to USB camera adapter">
        <h3 class="promo-title">Psst!... Did you know?</h3>
        <div class="promo-body">
            <p class="promo-message">
                You can connect your Kobo, a flash drive,
                or some other dongle straight
                to an iPhone's Lightning port using a camera adapter.
                <a href="https://amzn.to/3XwjFuJ" target="_blank"
                   rel="noopener">Get one from Amazon</a>.
            </p>
            <img class="promo-image" src="img/lightning-camera-adapter.png"
                 alt="Lightning to USB camera adapter" width="300" height="47"/>
        </div>
        <div class="promo-disclaimer">Disclosure: As an Amazon Associate I earn from qualifying
            purchases.
        </div>
    </div>
    <script>
        (function () {
            var url = 'https://amzn.to/3XwjFuJ';
            var el = document.getElementById('promoAmazon');
            if (!el) return;
            el.addEventListener('click', function (e) {
                if (e.target && e.target.closest('a')) return; // follow inner links normally
                window.open(url, '_blank', 'noopener');
            });
            el.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    window.open(url, '_blank', 'noopener');
                }
            });
        })();
    </script>

    <div class="drop-zone" id="dropZone">
        <div class="drop-text">Drop your messed up EPUB here</div>
        <div class="drop-sub">or <span class="click-word">click</span> to select one</div>
        <div class="drop-sub">(We'll handle the rest)</div>
        <input type="file" id="fileInput" accept=".epub">
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar-shell">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <div class="status-text" id="statusText">Spinning up the hamsters...</div>
    </div>

    <div class="disclaimer">
        <p>
            Disclaimer: We are pretty good at this, but on rare occasions, the resulting file might look even uglier
            than the original if the publisher did something truly bizarre with their styling.
        </p>
        <p>
            In this case try opting out of some fixes and try again:</p>
        <div class="options-container">
            <div class="option-card">
                <label>
                    <input type="checkbox" id="fix-line-height" checked>
                    <span class="opt-title">Line Spacing</span>
                </label>
            </div>
            <div class="option-card">
                <label>
                    <input type="checkbox" id="fix-align" checked>
                    <span class="opt-title">Text Alignment</span>
                </label>
            </div>
            <div class="option-card">
                <label>
                    <input type="checkbox" id="fix-fontsize" checked>
                    <span class="opt-title">Font Size</span>
                </label>
            </div>
        </div>

        <p>Purists who downloaded their books from the Ocean Of PDF will appreciate the opportunity to:</p>

        <div class="option-card" style="align-content: center;">
            <label>
                <input type="checkbox" id="fix-ocean">
                <span class="opt-title">Remove links to Ocean of PDF</span>
            </label>
        </div>

    </div>

    <div class="links-section" aria-labelledby="free-epub-heading">
        <h3 id="free-epub-heading">Free EPUB Books</h3>
        <p class="links-intro">
            Here are some places to <strong>download free EPUB books</strong>
            — from carefully produced public domain editions to publisher‑approved freebies and library lending.
            Most are DRM‑free and play nicely with popular e‑readers and reading apps.
        </p>

        <ul class="resource-cards">
            <li class="resource-card" role="link" tabindex="0">
                <div class="site-head">
                    <h4 class="site-title">Project Gutenberg</h4>
                    <a class="site-link" href="https://www.gutenberg.org/" target="_blank" rel="noopener noreferrer" aria-label="Visit Project Gutenberg (opens in a new tab)">Visit site</a>
                </div>
                <div class="site-tagline">Public-domain EPUB classics</div>
                <p class="site-desc">70,000+ classics in tidy EPUB. Legal, timeless, and pleasantly free of pop‑ups.</p>
            </li>
            <li class="resource-card" role="link" tabindex="0">
                <div class="site-head">
                    <h4 class="site-title">Standard Ebooks</h4>
                    <a class="site-link" href="https://standardebooks.org/" target="_blank" rel="noopener noreferrer" aria-label="Visit Standard Ebooks (opens in a new tab)">Visit site</a>
                </div>
                <div class="site-tagline">Beautifully formatted, proofread</div>
                <p class="site-desc">Hand‑crafted editions. Like Gutenberg, but ironed, lint‑rolled, and wearing a bow tie.</p>
            </li>
            <li class="resource-card" role="link" tabindex="0">
                <div class="site-head">
                    <h4 class="site-title">ManyBooks</h4>
                    <a class="site-link" href="https://manybooks.net/" target="_blank" rel="noopener noreferrer" aria-label="Visit ManyBooks (opens in a new tab)">Visit site</a>
                </div>
                <div class="site-tagline">Large free catalog</div>
                <p class="site-desc">Public‑domain and indie titles. Some gems, some… character building. All EPUB‑friendly.</p>
            </li>
            <li class="resource-card" role="link" tabindex="0">
                <div class="site-head">
                    <h4 class="site-title">epubBooks</h4>
                    <a class="site-link" href="https://www.epubbooks.com/" target="_blank" rel="noopener noreferrer" aria-label="Visit epubBooks (opens in a new tab)">Visit site</a>
                </div>
                <div class="site-tagline">Curated free classics</div>
                <p class="site-desc">Clean layouts, easy downloads, zero drama. Your e‑reader will send a thank‑you note.</p>
            </li>
            <li class="resource-card" role="link" tabindex="0">
                <div class="site-head">
                    <h4 class="site-title">Baen Free Library</h4>
                    <a class="site-link" href="https://www.baen.com/allbooks/category/index/id/2012" target="_blank" rel="noopener noreferrer" aria-label="Visit Baen Free Library (opens in a new tab)">Visit site</a>
                </div>
                <div class="site-tagline">Free SF/F from the publisher</div>
                <p class="site-desc">Spaceships, sorcery, and snark. DRM‑free EPUBs straight from the publisher. Pew pew.</p>
            </li>
            <li class="resource-card" role="link" tabindex="0">
                <div class="site-head">
                    <h4 class="site-title">Open Library</h4>
                    <a class="site-link" href="https://openlibrary.org/" target="_blank" rel="noopener noreferrer" aria-label="Visit Open Library (opens in a new tab)">Visit site</a>
                </div>
                <div class="site-tagline">Borrow ebooks online</div>
                <p class="site-desc">Millions of books to borrow. Think library card, but on your couch. Procrastination guaranteed.</p>
            </li>
        </ul>
    </div>
    <script>
        // Make whole resource card clickable (not just the right-aligned hyperlink)
        (function () {
            var cards = document.querySelectorAll('.resource-card');
            cards.forEach(function (card) {
                var link = card.querySelector('.site-link');
                if (!link) return;

                // Click anywhere on the card opens the link, except when clicking an actual anchor inside
                card.addEventListener('click', function (e) {
                    if (e.target && e.target.closest('a')) return;
                    window.open(link.href, '_blank', 'noopener');
                });

                // Keyboard accessibility: Enter or Space opens the link
                card.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        window.open(link.href, '_blank', 'noopener');
                    }
                });
            });
        })();
    </script>
</main>

<footer>
    <div class="footer-links">&copy;
        <script>document.write(new Date().getFullYear().toString())</script>
        <a href="https://www.birdcorner.app" target="_blank">Bird Corner Apps</a>
        <br/>
        Made with ☕ and sarcasm
    </div>
</footer>

<div id="cookieBanner" class="cookie-banner">
    <div class="cookie-text">
        We use cookies. Not the tasty kind, sadly. Just the digital crumbs that tell us if anyone actually uses this
        thing. Cool?
    </div>
    <div class="cookie-buttons">
        <button id="btnDecline" class="cookie-btn btn-decline">Nah, I'm a ghost</button>
        <button id="btnAccept" class="cookie-btn btn-accept">Fine, whatever</button>
    </div>
</div>

<script>
    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (isTouchDevice) {
        const clickElements = document.querySelectorAll('.click-word');
        clickElements.forEach(element => {
            element.textContent = 'tap';
        });
    }

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');

    // Drag and Drop Events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFile(files[0]);
    });

    dropZone.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
        if (file.type !== "application/epub+zip" && !file.name.endsWith('.epub')) {
            alert("Please upload a valid .epub file.");
            return;
        }

        // UI Reset
        progressContainer.style.display = 'block';
        dropZone.style.display = 'none';
        progressBar.style.width = '0%';

        // Start the "Fake" Progress Logic + Real Processing
        // noinspection JSUnresolvedReference
        if (typeof gtag === 'function') {
            // noinspection JSUnresolvedReference
            gtag('event', 'epub_fix_started', {
                'event_category': 'engagement',
                'event_label': 'EPUB Fix Started'
            });
        }
        processEpub(file);
    }

    async function processEpub(file) {
        // Get user preferences
        const fixLineHeight = document.getElementById('fix-line-height').checked;
        const fixAlign = document.getElementById('fix-align').checked;
        const fixFontSize = document.getElementById('fix-fontsize').checked;
        const fixOcean = document.getElementById('fix-ocean').checked;

        const nothingToDo = !(fixLineHeight || fixAlign || fixFontSize || fixOcean);
        if (nothingToDo) {
            alert("Nothing to do here.\nTry enabling some fixing options.");
            return;
        }

        const zip = new JSZip();

        // The total time we want the user to wait (for ads) - 6 seconds
        const fakeDuration = 6000;

        let failed = false;

        const messages = [
            "Analyzing styling crimes against humanity...",
            ...(fixLineHeight ? ["De-shackling line-heights..."] : []),
            ...(fixAlign ? ["Arguing with the text alignment..."] : []),
            ...(fixFontSize ? ["Unfixing fixed sizes..."] : []),
            ...(fixOcean ? ["Removing promotional spam..."] : []),
            "Polishing the metadata...",
            "Almost there...",
            "Re-packaging the unpackaged..."
        ];

        // Animation Loop for Progress Bar
        const animateProgress = new Promise((resolve) => {
            let start = null;

            function step(timestamp) {
                if (failed) {
                    resolve();
                    return
                }

                if (!start) start = timestamp;
                const progress = timestamp - start;
                const percentage = Math.min((progress / fakeDuration) * 100, 99); // go to 99%

                progressBar.style.width = percentage + '%';

                // Update text occasionally
                const msgIndex = Math.floor((percentage / 100) * messages.length);
                if (messages[msgIndex]) statusText.innerText = messages[msgIndex];

                if (progress < fakeDuration) {
                    window.requestAnimationFrame(step);
                } else {
                    resolve();
                }
            }

            window.requestAnimationFrame(step);
        });

        // The Actual Work (Should be faster than 6 s usually)
        const fileProcessing = (async () => {
            try {
                const contents = await zip.loadAsync(file);

                // Iterate over files
                for (const [filename, zipEntry] of Object.entries(contents.files)) {
                    if (zipEntry.dir) continue;

                    // CSS FILES
                    if (filename.endsWith('.css')) {
                        let cssText = await zipEntry.async("string");

                        if (fixLineHeight) {
                            // Regex: Remove line-height: anything;
                            cssText = cssText.replace(/line-height\s*:\s*[^;}!]+(\s*!important)?\s*[;}]/gi, '');
                        }
                        if (fixAlign) {
                            // Regex: Remove text-align: left/justify
                            cssText = cssText.replace(/text-align\s*:\s*(left|justify)(\s*!important)?\s*[;}]/gi, '');
                        }
                        if (fixFontSize) {
                            // Regex: Remove font-size: [number]px
                            cssText = cssText.replace(/font-size\s*:\s*[\d.]+px(\s*!important)?\s*[;}]/gi, '');
                        }

                        zip.file(filename, cssText);
                    }

                    // XHTML/HTML FILES (For Ocean of PDF)
                    if (fixOcean && (filename.endsWith('.xhtml') || filename.endsWith('.html') || filename.endsWith('.htm'))) {
                        let htmlContent = await zipEntry.async("string");

                        // Simple string check before parsing to save resources
                        if (htmlContent.includes('oceanofpdf.com')) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(htmlContent, "application/xml");

                            // Find links
                            const links = doc.querySelectorAll('a[href*="oceanofpdf.com"]');

                            let modified = false;
                            links.forEach(link => {
                                // Check if the parent is just a wrapper (p or div) and has no other text
                                const parent = link.parentElement;
                                if (parent && (parent.tagName === 'p' || parent.tagName === 'div') && parent.textContent.trim() === link.textContent.trim()) {
                                    parent.remove();
                                } else {
                                    link.remove();
                                }
                                modified = true;
                            });

                            if (modified) {
                                const serializer = new XMLSerializer();
                                zip.file(filename, serializer.serializeToString(doc));
                            }
                        }
                    }
                }
                return zip;
            } catch (e) {
                failed = true;
                console.error(e);
                // noinspection JSUnresolvedReference
                if (typeof gtag === 'function') {
                    // noinspection JSUnresolvedReference
                    gtag('event', 'epub_fix_failed', {
                        'event_category': 'engagement',
                        'event_label': 'EPUB Fix Failed',
                        'error_message': e.toString()
                    });
                }
                alert("Oops, something broke inside the file parser.");
                return null;
            }
        })();

        // Wait for BOTH the fake timer and the real work
        const [_, processedZip] = await Promise.all([animateProgress, fileProcessing]);

        progressBar.style.width = '100%';
        // Reset UI after short delay
        setTimeout(() => {
            progressContainer.style.display = 'none';
            dropZone.style.display = 'block';
            statusText.innerText = "Waiting for file...";
        }, 2000);

        if (processedZip) {
            statusText.innerText = "Done! Downloading...";

            // Generate download
            const content = await processedZip.generateAsync({type: "blob"});
            const url = window.URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;

            // Add -fixed suffix
            const originalName = file.name.replace(/\.epub$/i, "");
            a.download = `${originalName}-fixed.epub`;

            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Reset UI after short delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
                dropZone.style.display = 'block';
                statusText.innerText = "Waiting for file...";
            }, 2000);

            // Track event if analytics exists
            // noinspection JSUnresolvedReference
            if (typeof gtag === 'function') {
                // noinspection JSUnresolvedReference
                gtag('event', 'epub_fix_completed', {
                    'event_category': 'engagement',
                    'event_label': 'EPUB Fixed',
                    'option_line_height': document.getElementById('fix-line-height').checked,
                    'option_alignment': document.getElementById('fix-align').checked,
                    'option_font_size': document.getElementById('fix-fontsize').checked,
                    'option_ocean': document.getElementById('fix-ocean').checked,
                });
            }
        } else {
            statusText.innerText = "Failed.";
        }
    }
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((reg) => console.log('Service Worker registered!', reg))
                .catch((err) => console.log('Service Worker failed:', err));
        });
    }
</script>

<script>
    // Cookie Consent Logic
    (function () {
        const banner = document.getElementById('cookieBanner');
        const btnAccept = document.getElementById('btnAccept');
        const btnDecline = document.getElementById('btnDecline');
        const STORAGE_KEY = 'cookie_consent';

        function setConsent(granted) {
            const status = granted ? 'granted' : 'denied';
            localStorage.setItem(STORAGE_KEY, status);

            // noinspection JSUnresolvedReference
            if (typeof gtag === 'function') {
                gtag('consent', 'update', {
                    'ad_storage': status,
                    'analytics_storage': status
                });
            }

            banner.style.display = 'none';
        }

        // Check existing consent
        const savedConsent = localStorage.getItem(STORAGE_KEY);

        if (savedConsent === 'granted') {
            // noinspection JSUnresolvedReference
            if (typeof gtag === 'function') {
                gtag('consent', 'update', {
                    'ad_storage': 'granted',
                    'analytics_storage': 'granted'
                });
            }
        } else if (savedConsent === 'denied') {
            // Already denied, do nothing (default is denied)
        } else {
            // No choice made yet, show banner
            banner.style.display = 'flex';
        }

        if (btnAccept) btnAccept.addEventListener('click', () => setConsent(true));
        if (btnDecline) btnDecline.addEventListener('click', () => setConsent(false));
    })();
</script>

</body>

</html>